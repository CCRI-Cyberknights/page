<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CCRI Cybersecurity Club</title>
  <meta name="description" content="CCRI Cybersecurity Club QR landing pages">
  <link rel="icon" href="cybersmith.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  <script src="./qrcode.min.js"></script>
  <style>
    :root { color-scheme: dark; }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <div class="w-full bg-[#00703d] text-white text-xs tracking-wide">
    <div class="max-w-5xl mx-auto px-4 py-2 flex flex-wrap items-center justify-center gap-3 text-center">
      <span class="font-semibold">Excitement</span>
      <span>•</span>
      <span class="font-semibold">Opportunity</span>
      <span>•</span>
      <span class="font-semibold">Belonging</span>
    </div>
  </div>
  <header class="max-w-5xl mx-auto px-4 py-6 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <img src="cybersmith.png" alt="CyberKnights" class="w-10 h-10 rounded" />
      <h1 class="text-xl font-semibold tracking-tight">CCRI Cybersecurity Club</h1>
    </div>
    <nav class="hidden sm:flex gap-4 text-sm">
      <a href="#/home" class="hover:text-emerald-300">Home</a>
      <a href="#/cybersecurity" class="hover:text-emerald-300">Club</a>
      <a href="#/linux" class="hover:text-emerald-300">Linux Guide</a>
      <a href="#/calendar" class="hover:text-emerald-300">Calendar</a>
    </nav>
  </header>

  <main id="app" class="max-w-5xl mx-auto px-4 pb-24"></main>

  <footer class="border-t border-slate-800/60 mt-16">
    <div class="max-w-5xl mx-auto px-4 py-6 text-xs text-slate-400 flex items-center justify-between">
      <div>
        © <span id="year"></span> CCRI Cybersecurity Club
        <span class="mx-2">•</span>
        <a href="https://github.com/CCRI-Cyberknights/page" target="_blank" rel="noopener noreferrer" class="hover:text-emerald-300">GitHub</a>
        <span class="mx-1">/</span>
        <a href="https://github.com/CCRI-Cyberknights/page/blob/main/CALENDAR-UPDATING.md" target="_blank" rel="noopener noreferrer" class="hover:text-emerald-300">Maintainer docs</a>
      </div>
      <div class="relative">
        <button id="footer-qr-toggle" class="hover:text-emerald-300">QR Code</button>
        <div id="footer-qr-panel" class="hidden absolute right-0 bottom-8 p-4 rounded-lg border border-slate-800 bg-slate-900/95 shadow-lg w-[500px] sm:w-[500px] max-w-[90vw]">
          <div class="space-y-2">
            <div>
              <input id="footer-qr-input" type="text" placeholder="Enter text or URL" class="w-full px-2 py-1 rounded bg-slate-800 border border-slate-700 outline-none focus:border-emerald-500 text-slate-200" />
            </div>
            <div class="text-[11px] text-slate-400 space-y-1">
              <div class="flex justify-between">
                <span>Defaults to this page’s URL</span>
                <span id="footer-qr-length" class="ml-4 text-right">Length: 0</span>
              </div>
              <div>Edit to generate any QR</div>
            </div>
            <div class="space-y-3">
              <div class="rounded border border-slate-800 bg-slate-900/60 p-2">
                <div class="flex flex-wrap items-center justify-between gap-2 text-[11px] text-slate-400">
                  <div id="footer-qr-info"></div>
                  <div class="flex items-center gap-1">
                    <span class="mr-1">Error Correction Level (ECL):</span>
                    <button id="footer-qr-ecl-dec" class="px-1 py-0.5 rounded border border-slate-700 hover:border-slate-600" title="Lower error correction">−</button>
                    <span id="footer-qr-ecl" class="min-w-[1.5ch] text-slate-200 text-xs text-center">M</span>
                    <button id="footer-qr-ecl-inc" class="px-1 py-0.5 rounded border border-slate-700 hover:border-slate-600" title="Raise error correction">+</button>
                  </div>
                </div>
              </div>
              <div class="flex justify-center">
                <div class="p-8 rounded border border-slate-800 bg-slate-900/60 inline-block">
                  <canvas id="footer-qr-canvas" class="bg-white p-1 rounded" width="160" height="160"></canvas>
                  <img id="footer-qr-img" alt="QR code" class="hidden bg-white p-1 rounded" width="160" height="160" />
                </div>
              </div>
              <div class="flex justify-center">
                <button id="footer-qr-download" class="px-3 py-1 rounded border border-slate-700 hover:border-slate-600">Download PNG</button>
              </div>
            </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <template id="page-home">
    <section class="grid lg:grid-cols-2 items-center gap-10 pt-4">
      <div class="space-y-6">
        <h2 class="text-3xl sm:text-4xl font-bold leading-tight">
          CyberKnights at CCRI
        </h2>
        <p class="text-slate-300">
          We’re a student community learning security together: workshops, labs,
          competitions, and projects. Start by joining the club or explore our Linux guide.
        </p>
        <div class="flex flex-wrap gap-3">
          <a href="#/cybersecurity" class="px-4 py-2 rounded bg-[#22c55e] text-slate-900 font-medium hover:bg-[#16a34a]">Go to Club Page</a>
          <a href="#/linux" class="px-4 py-2 rounded border border-slate-700 hover:border-slate-600">USB Linux Guide</a>
        </div>
      </div>
      <div class="flex justify-center">
        <img src="cybersmith.png" alt="CyberKnights" class="w-72 h-72 object-contain drop-shadow-[0_0_40px_rgba(16,185,129,0.25)]" />
      </div>
    </section>

    <section class="mt-12">
      <div class="p-6 rounded-lg border border-slate-800 bg-slate-900/40">
        <h3 class="text-lg font-semibold mb-2">Our Philosophy</h3>
        <p class="text-slate-300">
          We keep the business card and this site simple for a reason. The back of the card says it best:
          <span class="font-semibold text-white">Excitement</span>, <span class="font-semibold text-white">Opportunity</span>, and <span class="font-semibold text-white">Belonging</span>.
          Learn practical skills, build your resume, and find a community that has your back.
        </p>
      </div>
    </section>
  </template>

  

  <template id="page-cybersecurity">
    <section class="grid lg:grid-cols-2 items-center gap-10 pt-4">
      <div class="space-y-6">
        <h2 class="text-3xl sm:text-4xl font-bold leading-tight">
          Welcome to the Cybersecurity Club
        </h2>
        <p class="text-slate-300">
          Learn, build, and compete with peers. Join workshops, talks, and
          hands-on labs covering security fundamentals through advanced topics.
        </p>
        <div class="flex flex-wrap gap-3">
          <a href="https://www.ccri.edu/its/cybersecurity/" target="_blank" rel="noopener noreferrer" class="px-4 py-2 rounded bg-[#22c55e] text-slate-900 font-medium hover:bg-[#16a34a]">
            Visit Cybersecurity Site
          </a>
          <a href="https://forms.cloud.microsoft/r/U26WUVJGgp" target="_blank" rel="noopener noreferrer" class="px-4 py-2 rounded border border-[#22c55e] text-[#22c55e] hover:bg-[#22c55e]/10">
            Sign Up
          </a>
        </div>
      </div>
      <div class="flex justify-center">
        <img src="cybersmith.png" alt="CyberKnights" class="w-72 h-72 object-contain drop-shadow-[0_0_40px_rgba(16,185,129,0.25)]" />
      </div>
    </section>

    <section class="mt-12 grid sm:grid-cols-2 gap-6">
      <div class="p-5 rounded-lg border border-slate-800 bg-slate-900/40">
        <h3 class="font-semibold mb-2">What we do</h3>
        <p class="text-slate-300 text-sm">Workshops, Linux hardening, CTFs, mentoring, and community.</p>
      </div>
      <div class="p-5 rounded-lg border border-slate-800 bg-slate-900/40">
        <h3 class="font-semibold mb-2">Get involved</h3>
        <p class="text-slate-300 text-sm">Join our meetings, Discord, and events throughout the semester.</p>
      </div>
    </section>
  </template>

  <template id="page-linux">
    <section class="space-y-6">
      <h2 class="text-3xl sm:text-4xl font-bold">CyberKnights Linux: USB Boot Guide</h2>
      <p class="text-slate-300">Follow these steps to boot from a USB drive.</p>

      <ol class="list-decimal list-inside space-y-2 text-slate-200">
        <li>Shut down your computer.</li>
        <li>Insert the prepared USB drive.</li>
        <li>Power on and press your one-time boot menu key (see below).</li>
        <li>Select the USB device and press Enter.</li>
        <li>Follow on-screen instructions to try or install.</li>
      </ol>

      <div class="mt-6 p-5 rounded-lg border border-slate-800 bg-slate-900/40">
        <h3 class="font-semibold mb-3">Common One-Time Boot Keys</h3>
        <div class="grid sm:grid-cols-2 gap-3 text-sm">
          <div><span class="text-slate-400">Dell</span>: F12</div>
          <div><span class="text-slate-400">HP</span>: Esc, F9</div>
          <div><span class="text-slate-400">Lenovo</span>: F12, Novo Button</div>
          <div><span class="text-slate-400">Acer</span>: F12</div>
          <div><span class="text-slate-400">ASUS</span>: Esc, F8</div>
          <div><span class="text-slate-400">MSI</span>: F11</div>
          <div><span class="text-slate-400">Toshiba</span>: F12</div>
          <div><span class="text-slate-400">Samsung</span>: Esc, F12</div>
        </div>
      </div>

      <div class="mt-6">
        <a href="#/cybersecurity" class="text-emerald-400 hover:text-emerald-300">Back to Club page</a>
      </div>
    </section>
  </template>

  <template id="page-calendar">
    <section class="space-y-6">
      <h2 class="text-3xl sm:text-4xl font-bold">Club Calendar</h2>
      <p class="text-slate-300">Upcoming meetings and events managed via the club Google Calendar.</p>
      <div class="flex flex-wrap gap-3">
        <a id="calendar-add-google" href="#" target="_blank" rel="noopener noreferrer" class="px-3 py-1.5 rounded bg-emerald-500 text-slate-900 font-medium hover:bg-emerald-400 text-sm">Add to Google Calendar</a>
        <a id="calendar-subscribe-link" href="#" target="_blank" rel="noopener noreferrer" class="px-3 py-1.5 rounded bg-blue-500 text-slate-900 font-medium hover:bg-blue-400 text-sm">Download .ics</a>
      </div>

      <div id="calendar-callout" class="p-4 rounded border border-amber-500/40 bg-amber-900/20 text-amber-200 text-sm"></div>

      <div class="rounded-lg overflow-hidden border border-slate-800 bg-slate-900/40">
        <iframe id="calendar-iframe" src="" title="CCRI Cybersecurity Club Calendar" width="100%" height="800" frameborder="0" scrolling="auto"></iframe>
      </div>

      
    </section>
  </template>

  <script>
    const CALENDAR_EMBED_URL = "https://calendar.google.com/calendar/embed?src=Y2NyaWN5YmVya25pZ2h0Y2x1YkBnbWFpbC5jb20&ctz=America/New_York"; // Optional: Google Calendar embed URL
    const CALENDAR_ICS_URL = "https://calendar.google.com/calendar/ical/Y2NyaWN5YmVya25pZ2h0Y2x1YkBnbWFpbC5jb20/public/basic.ics";    // Public Google Calendar ICS URL
    const DOCS_CALENDAR_URL = "https://github.com/CCRI-Cyberknights/page/blob/main/CALENDAR-UPDATING.md";
    const ENABLE_CUSTOM_CALENDAR = false; // Set to true to use ICS-powered list + FullCalendar
    let fcInstance = null;

    const routes = {
      home: document.getElementById('page-home').innerHTML,
      cybersecurity: document.getElementById('page-cybersecurity').innerHTML,
      linux: document.getElementById('page-linux').innerHTML,
      calendar: document.getElementById('page-calendar').innerHTML
    };

    function normalizeHashRouting() {
      // If old query-param links like ?page=calendar are used, rewrite to #/calendar
      const params = new URLSearchParams(window.location.search);
      const legacy = params.get('page');
      if (legacy && !window.location.hash) {
        const clean = window.location.pathname + '#/' + legacy;
        history.replaceState(null, '', clean);
      }
    }

    function render() {
      const hash = (location.hash || '').replace(/^#\/?/, '');
      const page = hash || 'home';
      const html = routes[page] || routes.cybersecurity;
      document.getElementById('app').innerHTML = html;
      if (page === 'calendar') {
        const iframe = document.getElementById('calendar-iframe');
        const callout = document.getElementById('calendar-callout');
        const directLink = document.getElementById('calendar-direct-link');
        const subscribeLink = document.getElementById('calendar-subscribe-link');
        const addGoogleLink = document.getElementById('calendar-add-google');
        if (CALENDAR_EMBED_URL && iframe) {
          iframe.src = CALENDAR_EMBED_URL;
          if (callout) callout.style.display = 'none';
          if (directLink) directLink.href = CALENDAR_EMBED_URL;
        }

        // Always show the green "Add to Your Google Calendar" button when an ICS is configured
        if (subscribeLink) {
          if (CALENDAR_ICS_URL) {
            const webcalUrl = CALENDAR_ICS_URL.replace(/^https?:\/\//, 'webcal://');
            subscribeLink.href = webcalUrl;
            subscribeLink.style.display = '';
          } else {
            subscribeLink.style.display = 'none';
          }
        }

        if (addGoogleLink) {
          const calendarId = 'Y2NyaWN5YmVya25pZ2h0Y2x1YkBnbWFpbC5jb20';
          addGoogleLink.href = 'https://calendar.google.com/calendar/u/0/r?cid=' + calendarId;
        }

        if (ENABLE_CUSTOM_CALENDAR && CALENDAR_ICS_URL) {
          fetchAndRenderEvents(CALENDAR_ICS_URL);
          fetchAndRenderFullCalendar(CALENDAR_ICS_URL);
        }

        if (callout) {
          if (!CALENDAR_EMBED_URL || (ENABLE_CUSTOM_CALENDAR && !CALENDAR_ICS_URL)) {
            callout.innerHTML = 'Maintainers: <a href="' + DOCS_CALENDAR_URL + '" target="_blank" rel="noopener noreferrer" class="underline">see docs</a>.';
          } else {
            callout.style.display = 'none';
          }
        }

        

        if (!ENABLE_CUSTOM_CALENDAR) {
          const nextSection = document.getElementById('next-event');
          const upcomingSection = document.getElementById('upcoming-events-section');
          const fc = document.getElementById('fc-container');
          if (nextSection) nextSection.style.display = 'none';
          if (upcomingSection) upcomingSection.style.display = 'none';
          if (fc) fc.style.display = 'none';
        }
      }
      updateFooterQr(page);
    }

    function unfoldIcsLines(icsText) {
      const rawLines = icsText.replace(/\r/g, '').split('\n');
      const lines = [];
      for (const line of rawLines) {
        if (!line) continue;
        if (line.startsWith(' ') || line.startsWith('\t')) {
          lines[lines.length - 1] += line.slice(1);
        } else {
          lines.push(line);
        }
      }
      return lines;
    }

    function parseIcsDate(value) {
      // Supports YYYYMMDD and YYYYMMDDTHHMMSSZ or local time without Z
      if (!value) return null;
      const dateOnly = /^\d{8}$/;
      const dateTime = /(\d{8})T(\d{6})(Z?)/;
      if (dateOnly.test(value)) {
        const y = value.slice(0,4), m = value.slice(4,6), d = value.slice(6,8);
        return new Date(`${y}-${m}-${d}T00:00:00`);
      }
      const m = value.match(dateTime);
      if (m) {
        const ymd = m[1];
        const hms = m[2];
        const z = m[3] === 'Z' ? 'Z' : '';
        const y = ymd.slice(0,4), mo = ymd.slice(4,6), d = ymd.slice(6,8);
        const hh = hms.slice(0,2), mm = hms.slice(2,4), ss = hms.slice(4,6);
        return new Date(`${y}-${mo}-${d}T${hh}:${mm}:${ss}${z}`);
      }
      return new Date(value);
    }

    function parseIcs(icsText) {
      const lines = unfoldIcsLines(icsText);
      const events = [];
      let current = null;
      let rrule = null;
      for (const line of lines) {
        if (line === 'BEGIN:VEVENT') { current = {}; rrule = null; continue; }
        if (line === 'END:VEVENT') {
          if (current) {
            if (rrule) current.rrule = rrule;
            events.push(current);
            current = null;
            rrule = null;
          }
          continue;
        }
        if (!current) continue;
        const idx = line.indexOf(':');
        if (idx === -1) continue;
        const nameAndParams = line.slice(0, idx);
        const value = line.slice(idx + 1);
        const prop = nameAndParams.split(';')[0].toUpperCase();
        switch (prop) {
          case 'DTSTART': current.start = parseIcsDate(value); break;
          case 'DTEND': current.end = parseIcsDate(value); break;
          case 'SUMMARY': current.title = value; break;
          case 'DESCRIPTION': current.description = value; break;
          case 'LOCATION': current.location = value; break;
          case 'URL': current.url = value; break;
          case 'RRULE': rrule = value; break;
        }
      }
      return events.filter(e => e.start instanceof Date && !isNaN(e.start));
    }

    function formatDateRange(start, end) {
      const sameDay = end && start.toDateString() === end.toDateString();
      const dateFmt = new Intl.DateTimeFormat(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
      const timeFmt = new Intl.DateTimeFormat(undefined, { hour: 'numeric', minute: '2-digit' });
      const dateStr = dateFmt.format(start);
      if (!end) return `${dateStr} • ${timeFmt.format(start)}`;
      if (sameDay) return `${dateStr} • ${timeFmt.format(start)} – ${timeFmt.format(end)}`;
      return `${dateStr} ${timeFmt.format(start)} → ${dateFmt.format(end)} ${timeFmt.format(end)}`;
    }

    function classifyEvent(e) {
      const title = (e.title || '').toLowerCase();
      const isWeekly = e.rrule && /FREQ=WEEKLY/i.test(e.rrule);
      const isRegularByTitle = /(meeting|hang|weekly)/i.test(title);
      return (isWeekly || isRegularByTitle) ? 'regular' : 'special';
    }

    function buildIcsForEvent(e) {
      const pad = (n) => String(n).padStart(2, '0');
      const toIcsDate = (d) => `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}T${pad(d.getUTCHours())}${pad(d.getUTCMinutes())}${pad(d.getUTCSeconds())}Z`;
      const dtstart = toIcsDate(e.start);
      const dtend = e.end ? toIcsDate(e.end) : toIcsDate(new Date(e.start.getTime() + 60*60*1000));
      const summary = (e.title || 'Event').replace(/\n/g, ' ');
      const description = (e.description || '').replace(/\n/g, ' ');
      const location = (e.location || '').replace(/\n/g, ' ');
      const uid = `${dtstart}-${summary.replace(/[^A-Za-z0-9]+/g,'-')}@ccri-cyberclub`;
      const lines = [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//CCRI Cybersecurity Club//EN','BEGIN:VEVENT',
        `UID:${uid}`,`DTSTAMP:${toIcsDate(new Date())}`,`DTSTART:${dtstart}`,`DTEND:${dtend}`,
        `SUMMARY:${summary}`, description ? `DESCRIPTION:${description}` : '', location ? `LOCATION:${location}` : '', 'END:VEVENT','END:VCALENDAR'
      ].filter(Boolean);
      return 'data:text/calendar;charset=utf-8,' + encodeURIComponent(lines.join('\n'));
    }

    function googleCalendarLink(e) {
      const fmt = (d) => d.toISOString().replace(/[-:]|\.\d{3}/g,'');
      const dates = e.end ? `${fmt(e.start)}/${fmt(e.end)}` : `${fmt(e.start)}`;
      const params = new URLSearchParams({
        action: 'TEMPLATE',
        text: e.title || 'Event',
        dates,
        details: e.description || '',
        location: e.location || ''
      });
      return `https://www.google.com/calendar/render?${params.toString()}`;
    }

    function renderEvents(events) {
      const now = new Date();
      const expanded = expandRecurring(events, now);
      const upcoming = expanded.filter(e => e.end ? e.end >= now : e.start >= now)
                               .sort((a,b) => a.start - b.start);
      const nextContainer = document.getElementById('next-event');
      const nextCard = document.getElementById('next-event-card');
      const list = document.getElementById('events-list');
      const empty = document.getElementById('events-empty');
      if (!list) return;
      list.innerHTML = '';
      if (upcoming.length === 0) {
        if (empty) empty.classList.remove('hidden');
        return;
      }
      if (empty) empty.classList.add('hidden');

      const [nextEvent, ...rest] = upcoming;
      if (nextContainer && nextCard && nextEvent) {
        nextContainer.classList.remove('hidden');
        nextCard.innerHTML = `
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 text-emerald-300 font-semibold">${new Intl.DateTimeFormat(undefined, {month:'short'}).format(nextEvent.start)}<div class="text-2xl leading-none">${nextEvent.start.getDate()}</div></div>
            <div class="space-y-1">
              <div class="text-lg font-semibold">${nextEvent.title || 'Untitled Event'}</div>
              <div class="text-slate-300 text-sm">${formatDateRange(nextEvent.start, nextEvent.end)}</div>
              ${nextEvent.location ? `<div class="text-slate-400 text-sm">${nextEvent.location}</div>` : ''}
              <div class="pt-3 flex flex-wrap gap-3 items-center">
                ${nextEvent.url ? `<a href="${nextEvent.url}" target="_blank" rel="noopener noreferrer" class="text-emerald-400 hover:text-emerald-300 text-sm">Details</a>` : ''}
                <a href="${buildIcsForEvent(nextEvent)}" download="event.ics" class="px-3 py-1.5 rounded border border-slate-700 hover:border-slate-600 text-xs">Add to Calendar (ICS)</a>
                <a href="${googleCalendarLink(nextEvent)}" target="_blank" rel="noopener noreferrer" class="px-3 py-1.5 rounded bg-emerald-500 text-slate-900 font-medium hover:bg-emerald-400 text-xs">Add to Google</a>
                <span class="ml-2 text-[10px] uppercase tracking-wide ${classifyEvent(nextEvent)==='regular' ? 'text-sky-300' : 'text-fuchsia-300'}">${classifyEvent(nextEvent)}</span>
              </div>
            </div>
          </div>`;
      }

      for (const e of rest.slice(0, 10)) {
        const item = document.createElement('div');
        item.className = 'p-4 rounded-lg border border-slate-800 bg-slate-900/40';
        item.innerHTML = `
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0 text-emerald-300 font-medium">${new Intl.DateTimeFormat(undefined, {month:'short'}).format(e.start)}<div class="text-xl leading-none">${e.start.getDate()}</div></div>
            <div class="space-y-1">
              <div class="font-semibold">${e.title || 'Untitled Event'}</div>
              <div class="text-slate-300 text-sm">${formatDateRange(e.start, e.end)}</div>
              ${e.location ? `<div class="text-slate-400 text-sm">${e.location}</div>` : ''}
              <div class="pt-2 flex flex-wrap gap-3 items-center">
                ${e.url ? `<a href="${e.url}" target="_blank" rel="noopener noreferrer" class="text-emerald-400 hover:text-emerald-300 text-sm">Details</a>` : ''}
                <a href="${buildIcsForEvent(e)}" download="event.ics" class="px-3 py-1 rounded border border-slate-700 hover:border-slate-600 text-xs">ICS</a>
                <a href="${googleCalendarLink(e)}" target="_blank" rel="noopener noreferrer" class="px-3 py-1 rounded bg-emerald-500 text-slate-900 font-medium hover:bg-emerald-400 text-xs">Google</a>
                <span class="ml-2 text-[10px] uppercase tracking-wide ${classifyEvent(e)==='regular' ? 'text-sky-300' : 'text-fuchsia-300'}">${classifyEvent(e)}</span>
              </div>
            </div>
          </div>`;
        list.appendChild(item);
      }
    }

    function expandRecurring(events, now) {
      // Minimal weekly RRULE expansion for the next ~90 days
      const horizonMs = 90 * 24 * 60 * 60 * 1000;
      const horizon = new Date(now.getTime() + horizonMs);
      const out = [];
      for (const e of events) {
        if (e.rrule && /FREQ=WEEKLY/i.test(e.rrule)) {
          const intervalMatch = e.rrule.match(/INTERVAL=(\d+)/i);
          const interval = intervalMatch ? parseInt(intervalMatch[1], 10) : 1;
          const bydayMatch = e.rrule.match(/BYDAY=([A-Z,]+)/i);
          const days = bydayMatch ? bydayMatch[1].split(',') : [];
          const baseDow = e.start.getUTCDay();
          const map = {SU:0, MO:1, TU:2, WE:3, TH:4, FR:5, SA:6};
          const start = new Date(e.start);
          let cursor = new Date(start);
          // generate weeks
          while (cursor <= horizon) {
            const occurrences = days.length ? days.map(code => map[code]).filter(d=>d!=null) : [baseDow];
            for (const dow of occurrences) {
              const occ = new Date(Date.UTC(cursor.getUTCFullYear(), cursor.getUTCMonth(), cursor.getUTCDate()));
              const delta = (dow - occ.getUTCDay() + 7) % 7;
              occ.setUTCDate(occ.getUTCDate() + delta);
              const occStart = new Date(occ);
              occStart.setUTCHours(e.start.getUTCHours(), e.start.getUTCMinutes(), e.start.getUTCSeconds(), 0);
              const duration = e.end ? (e.end - e.start) : 60*60*1000;
              const occEnd = new Date(occStart.getTime() + duration);
              if (occEnd >= now && occStart <= horizon) {
                out.push({...e, start: new Date(occStart), end: new Date(occEnd)});
              }
            }
            cursor.setUTCDate(cursor.getUTCDate() + 7 * interval);
          }
        } else {
          out.push(e);
        }
      }
      return out;
    }

    async function fetchAndRenderEvents(icsUrl) {
      try {
        let text = '';
        let res = await fetch(icsUrl, { cache: 'no-store' });
        if (!res.ok) {
          throw new Error('Primary fetch failed');
        }
        text = await res.text();
        const events = parseIcs(text);
        renderEvents(events);
      } catch (err) {
        console.warn('ICS fetch failed, trying CORS proxy', err);
        try {
          const proxied = 'https://r.jina.ai/http://'+ icsUrl.replace(/^https?:\/\//,'');
          const res2 = await fetch(proxied, { cache: 'no-store' });
          if (!res2.ok) throw new Error('Proxy fetch failed');
          const text2 = await res2.text();
          const events2 = parseIcs(text2);
          renderEvents(events2);
        } catch (err2) {
          console.warn('ICS proxy fetch/parse failed', err2);
        }
      }
    }

    async function fetchAndRenderFullCalendar(icsUrl) {
      try {
        let text = '';
        let res = await fetch(icsUrl, { cache: 'no-store' });
        if (!res.ok) throw new Error('Primary fetch failed');
        text = await res.text();
        renderFullCalendarFromIcs(text);
      } catch (err) {
        try {
          const proxied = 'https://r.jina.ai/http://' + icsUrl.replace(/^https?:\/\//, '');
          const res2 = await fetch(proxied, { cache: 'no-store' });
          if (!res2.ok) throw new Error('Proxy fetch failed');
          const text2 = await res2.text();
          renderFullCalendarFromIcs(text2);
        } catch (e) {
          console.warn('FullCalendar ICS load failed', e);
        }
      }
    }

    function renderFullCalendarFromIcs(icsText) {
      const events = parseIcs(icsText);
      const expanded = expandRecurring(events, new Date());
      const fcEvents = expanded.map(e => ({
        title: e.title || 'Event',
        start: e.start,
        end: e.end,
        url: e.url || undefined
      }));
      const el = document.getElementById('fullcalendar');
      if (!el || !window.FullCalendar) return;
      if (fcInstance) { fcInstance.destroy(); fcInstance = null; }
      fcInstance = new FullCalendar.Calendar(el, {
        initialView: 'dayGridMonth',
        height: 'auto',
        themeSystem: 'standard',
        eventClick: (info) => {
          if (info.event.url) { info.jsEvent.preventDefault(); window.open(info.event.url, '_blank', 'noopener'); }
        },
        events: fcEvents
      });
      fcInstance.render();
    }

    function updateFooterQr(page) {
      const toggle = document.getElementById('footer-qr-toggle');
      const panel = document.getElementById('footer-qr-panel');
      const canvas = document.getElementById('footer-qr-canvas');
      const dl = document.getElementById('footer-qr-download');
      const copyBtn = document.getElementById('footer-qr-copy');
      if (!toggle || !panel || !canvas) return;
      const url = window.location.href; // exact URL, includes ?page=...
      const ECL_LEVELS = ['L','M','Q','H'];
      let eclIndex = 1; // default 'M'
      const infoEl = document.getElementById('footer-qr-info');
      const render = (text) => {
        if (window.QRCode) {
          try {
            // compute model to surface version/module count
            let versionDesc = '';
            try {
              const model = QRCode.create(text, { errorCorrectionLevel: ECL_LEVELS[eclIndex] });
              versionDesc = `QR Version ${model.version} (${model.modules.size}×${model.modules.size})`;
            } catch {}
            QRCode.toCanvas(canvas, text, { width: 160, margin: 1, errorCorrectionLevel: ECL_LEVELS[eclIndex] }, function(err){
              if (err) fallbackImg(text);
              if (infoEl) infoEl.textContent = versionDesc || '';
              const lenEl = document.getElementById('footer-qr-length');
              if (lenEl) lenEl.textContent = `Length: ${text.length}`;
            });
          } catch { fallbackImg(text); }
        } else {
          fallbackImg(text);
        }
      };
      function fallbackImg(text){
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if (infoEl) infoEl.textContent = `Encoder error`;
        const lenEl = document.getElementById('footer-qr-length');
        if (lenEl) lenEl.textContent = `length ${text.length}`;
      }
      render(url);
      // Input-driven generation
      const input = document.getElementById('footer-qr-input');
      const eclText = document.getElementById('footer-qr-ecl');
      const eclInc = document.getElementById('footer-qr-ecl-inc');
      const eclDec = document.getElementById('footer-qr-ecl-dec');
      if (input) {
        input.value = url;
        input.addEventListener('input', () => render(input.value || url));
        // Show the end of long text by moving caret to the end and scrolling right
        setTimeout(() => {
          try {
            const len = input.value.length;
            input.setSelectionRange(len, len);
            input.scrollLeft = input.scrollWidth;
          } catch {}
        }, 0);
        input.addEventListener('focus', () => {
          try {
            const len = input.value.length;
            input.setSelectionRange(len, len);
            input.scrollLeft = input.scrollWidth;
          } catch {}
        });
      }
      if (eclText) eclText.textContent = ECL_LEVELS[eclIndex];
      function reRender(){ render((input && input.value) || url); }
      if (eclInc) {
        eclInc.onclick = () => { if (eclIndex < ECL_LEVELS.length - 1) { eclIndex++; if (eclText) eclText.textContent = ECL_LEVELS[eclIndex]; reRender(); } };
      }
      if (eclDec) {
        eclDec.onclick = () => { if (eclIndex > 0) { eclIndex--; if (eclText) eclText.textContent = ECL_LEVELS[eclIndex]; reRender(); } };
      }
      if (dl) {
        dl.onclick = () => {
          const tmpCanvas = document.createElement('canvas');
          const text = (input && input.value) || url;
          try {
            QRCode.toCanvas(tmpCanvas, text, { width: 512, margin: 1, errorCorrectionLevel: ECL_LEVELS[eclIndex] }, () => {
              const link = document.createElement('a');
              link.download = `qr-${page}.png`;
              link.href = tmpCanvas.toDataURL('image/png');
              link.click();
            });
          } catch {
            // Fallback: copy current on-screen canvas into a PNG
            const ctx = tmpCanvas.getContext('2d');
            tmpCanvas.width = canvas.width; tmpCanvas.height = canvas.height;
            ctx.drawImage(canvas, 0, 0);
            const link = document.createElement('a');
            link.download = `qr-${page}.png`;
            link.href = tmpCanvas.toDataURL('image/png');
            link.click();
          }
        };
      }
      toggle.onclick = () => {
        panel.classList.toggle('hidden');
      };
    }

    window.addEventListener('hashchange', render);
    window.addEventListener('DOMContentLoaded', () => {
      document.getElementById('year').textContent = new Date().getFullYear();
      normalizeHashRouting();
      render();
    });
  </script>
</body>
</html>


