#!/bin/bash
# Husky pre-commit hook for Cyber Club Page
# Updated for tag-based deployment with standard-version

cd "$(dirname -- "$0")/.."

# Safety guard: Skip if HUSKY is disabled or if this is a release commit
if [ "$HUSKY" = "0" ]; then
    echo "ğŸš« Husky disabled - skipping pre-commit processing"
    exit 0
fi

# Check if this is a standard-version commit (skip processing)
if git log -1 --pretty=%B | grep -q "chore(release):"; then
    echo "ğŸ“¦ Standard-version release detected - skipping pre-commit processing"
    exit 0
fi

# Layout Pattern Validation (NEW)
echo "ğŸ” Validating layout patterns..."

# Check for forbidden flexbox patterns on body
if grep -r "flex flex-col" index.html | grep -q "body"; then
    echo "âŒ ERROR: Found 'flex flex-col' on body element"
    echo "   This creates conflicts with Tailwind's max-w-* mx-auto patterns"
    echo "   Use the wrapper pattern instead: <div class='flex flex-col min-h-screen'>"
    exit 1
fi

# Check for flex-grow on main
if grep -r "flex-grow" index.html | grep -q "main"; then
    echo "âŒ ERROR: Found 'flex-grow' on main element"
    echo "   Use 'flex-1' on main within wrapper div instead"
    exit 1
fi

# Check for mt-auto on footer
if grep -r "mt-auto" index.html | grep -q "footer"; then
    echo "âŒ ERROR: Found 'mt-auto' on footer element"
    echo "   Use 'mt-6' or similar fixed margin instead"
    exit 1
fi

echo "âœ… Layout patterns validated successfully"

# CI/CD Pipeline Validation (NEW)
echo "ğŸ” Validating CI/CD workflow scripts..."
bash tests/ci-validation/pre-commit-validation.sh

if [ $? -ne 0 ]; then
    echo "âŒ CI/CD workflow validation failed! Please fix workflow script references before committing."
    exit 1
fi

echo "âœ… CI/CD workflow validation passed"

# Check if any significant files have been modified (HTML, JS, JSON, or docs)
significant_files=$(git diff --cached --name-only | grep -E "\.(html|js|json)$|^docs/")
if [ -n "$significant_files" ]; then
    echo "ğŸ“ Significant files changed - checking for version bumping..."
    
    # Check if any HTML or JavaScript files have been modified for testing
    web_files=$(git diff --cached --name-only | grep -E "\.(html|js)$")
    if [ -n "$web_files" ]; then
        echo "ğŸŒ Web files changed - running comprehensive tests..."
        echo "ğŸ”— Running Playwright tests (links + version display)..."
        echo "ğŸŒ Testing production and local URLs with Playwright..."
        
        npm run test:links
        
        if [ $? -ne 0 ]; then
            echo "âŒ Playwright testing failed! Please fix issues before committing."
            exit 1
        fi
        
        echo "âœ… All tests passed - links and version display working correctly."
    else
        echo "ğŸ“„ No web files changed - skipping tests"
    fi
    
    # Always run version bumping for significant changes
    echo "ğŸš€ Running automatic version bump..."
    npm run version:auto
    
    if [ $? -eq 0 ]; then
        echo "âœ… Version bumped successfully"
    else
        echo "âŒ Version bumping failed! Please check the error above."
        exit 1
    fi
else
    echo "ğŸ“„ No significant files changed - skipping version bumping and link tests"
    echo "â„¹ï¸  Version management now handled by standard-version (npm run release)"
fi