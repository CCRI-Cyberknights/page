#!/bin/bash
# Husky pre-commit hook for CCRI Cyberknights Landing Pages
# Updated for tag-based deployment with standard-version

cd "$(dirname -- "$0")/.."

# Safety guard: Skip if HUSKY is disabled or if this is a release commit
if [ "$HUSKY" = "0" ]; then
    echo "🚫 Husky disabled - skipping pre-commit processing"
    exit 0
fi

# Check if this is a standard-version commit (skip processing)
if git log -1 --pretty=%B | grep -q "chore(release):"; then
    echo "📦 Standard-version release detected - skipping pre-commit processing"
    exit 0
fi

# Check if any significant files have been modified (HTML, JS, JSON, or docs)
significant_files=$(git diff --cached --name-only | grep -E "\.(html|js|json)$|^docs/")
if [ -n "$significant_files" ]; then
    echo "📝 Significant files changed - checking for version bumping..."
    
    # Check if any HTML or JavaScript files have been modified for testing
    web_files=$(git diff --cached --name-only | grep -E "\.(html|js)$")
    if [ -n "$web_files" ]; then
        echo "🌐 Web files changed - running comprehensive tests..."
        echo "🔗 Running Playwright tests (links + version display)..."
        echo "🌐 Testing production and local URLs with Playwright..."
        
        npm run test:links
        
        if [ $? -ne 0 ]; then
            echo "❌ Playwright testing failed! Please fix issues before committing."
            exit 1
        fi
        
        echo "✅ All tests passed - links and version display working correctly."
    else
        echo "📄 No web files changed - skipping tests"
    fi
    
    # Always run version bumping for significant changes
    echo "🚀 Running automatic version bump..."
    npm run version:auto
    
    if [ $? -eq 0 ]; then
        echo "✅ Version bumped successfully"
    else
        echo "❌ Version bumping failed! Please check the error above."
        exit 1
    fi
else
    echo "📄 No significant files changed - skipping version bumping and link tests"
    echo "ℹ️  Version management now handled by standard-version (npm run release)"
fi