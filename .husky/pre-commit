#!/bin/bash
# Husky pre-commit hook for CCRI Cyberknights Landing Pages
# Updated for tag-based deployment with standard-version

cd "$(dirname -- "$0")/.."

# Safety guard: Skip if HUSKY is disabled or if this is a release commit
if [ "$HUSKY" = "0" ]; then
    echo "ğŸš« Husky disabled - skipping pre-commit processing"
    exit 0
fi

# Check if this is a standard-version commit (skip processing)
if git log -1 --pretty=%B | grep -q "chore(release):"; then
    echo "ğŸ“¦ Standard-version release detected - skipping pre-commit processing"
    exit 0
fi

# Check if any significant files have been modified (HTML, JS, JSON, or docs)
significant_files=$(git diff --cached --name-only | grep -E "\.(html|js|json)$|^docs/")
if [ -n "$significant_files" ]; then
    echo "ğŸ“ Significant files changed - checking for version bumping..."
    
    # Check if any HTML files have been modified for link testing
    html_files=$(git diff --cached --name-only | grep "\.html$")
    if [ -n "$html_files" ]; then
        echo "ğŸ”— HTML files changed - running link tests..."
        
        # Check if only index.html was changed
        if [ "$html_files" = "index.html" ]; then
            echo "ğŸ“„ Only index.html changed - running link tests..."
        else
            echo "ğŸ” Multiple HTML files changed - running link tests..."
        fi
        
        echo "ğŸ”— Running Playwright link tests..."
        
        # Run comprehensive Playwright link testing
        echo "ğŸŒ Testing production and local URLs with Playwright..."
        npm run test:links
        
        if [ $? -ne 0 ]; then
            echo "âŒ Playwright link testing failed! Please fix broken links before committing."
            exit 1
        fi
        
        echo "âœ… All links are working correctly on both production and local."
    else
        echo "ğŸ“„ No HTML files changed - skipping link tests"
    fi
    
    # Always run version bumping for significant changes
    echo "ğŸš€ Running automatic version bump..."
    npm run version:auto
    
    if [ $? -eq 0 ]; then
        echo "âœ… Version bumped successfully"
    else
        echo "âŒ Version bumping failed! Please check the error above."
        exit 1
    fi
else
    echo "ğŸ“„ No significant files changed - skipping version bumping and link tests"
    echo "â„¹ï¸  Version management now handled by standard-version (npm run release)"
fi