#!/bin/bash
. "$(dirname -- "$0")/_/husky.sh"

cd "$(dirname -- "$0")/.."

# Check if any HTML files have been modified
if git diff --cached --name-only | grep -q "\.html$"; then
    echo "ğŸ”— HTML files changed - running parallel link tests..."
    . ./selenium_env/bin/activate
    
    # Test production URL first
    echo "ğŸŒ Testing production URL: https://ccri-cyberknights.github.io/page"
    python3 scripts/test-links-dynamic-parallel.py "https://ccri-cyberknights.github.io/page"
    
    if [ $? -ne 0 ]; then
        echo "âŒ Production link testing failed! Please fix broken links before committing."
        exit 1
    fi
    
    # Test local URL
    echo "ğŸ  Testing local URL: http://localhost:8000"
    python3 scripts/test-links-dynamic-parallel.py "http://localhost:8000"
    
    # Check if both link tests passed
    if [ $? -eq 0 ]; then
        echo "âœ… All links are working correctly on both production and local. Proceeding with version bump..."
        npm run version:auto
    else
        echo "âŒ Local link testing failed! Please fix broken links before committing."
        exit 1
    fi
else
    echo "ğŸ“„ No HTML files changed - skipping link tests"
    npm run version:auto
fi
